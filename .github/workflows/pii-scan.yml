name: PII Data Scan Pipeline

on:
  workflow_dispatch:
  
jobs:
  pii-scan:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup Java
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'

    - name: Download Gosu Distribution
      shell: bash
      run: |
        echo "Downloading Gosu distribution..."
        curl -L -o gosu.zip http://search.maven.org/remotecontent?filepath=org/gosu-lang/gosu/gosu/1.14.16/gosu-1.14.16-full.zip
        unzip gosu.zip -d gosu_dist

    - name: Find gosu.cmd
      id: find_gosu
      shell: pwsh
      run: |
          $gosu = Get-ChildItem -Path gosu_dist -Recurse -Filter "gosu.cmd" | Select-Object -First 1
          if (-not $gosu) {
            Write-Error "gosu.cmd not found!"
            exit 1
          }
          echo "Found gosu.cmd at $($gosu.FullName)"
          echo "GOSU_CMD=$($gosu.FullName)" | Out-File -FilePath $Env:GITHUB_ENV -Append

    - name: Build Gosu Applications
      shell: cmd
      run: |
        echo Building Gosu applications...
        if exist dist rmdir /s /q dist
        build-app.bat

    - name: Run PII Data Scan
      shell: cmd
      run: |
         echo Running PII Scanner...
         pushd "%GOSU_CMD%\.."  || exit /b 1
         gosu.cmd ..\..\..\PIIScanner.gs
         popd
        
    - name: Upload PII Scan Report
      uses: actions/upload-artifact@v4
      with:
        name: pii-scan-report
        path: pii-scan-report.log
        
    - name: Display Report Summary
      shell: cmd
      run: |
            if exist pii-scan-report.log (
            echo PII Scan Report Summary:
            type pii-scan-report.log
            ) else (
            echo "PII scan report not found!"
            exit /b 1
            )
